generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          String    @id @default(cuid())
  email       String    @unique
  name        String?
  passwordHash String?  // Hashed password for email/password auth
  role        String    @default("user") // owner, editor, viewer
  image       String?
  projects    Project[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("users")
}

model Project {
  id            String     @id @default(cuid())
  name          String
  description   String?
  ownerId       String
  owner         User       @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  storageConfig Json?      // Configuration de stockage personnalisée: {type: 's3'|'local'|'ftp'|'google-drive', config: {...}}
  emailConfig   Json?      // Configuration système d'email: {organizationName, appName, contactEmail}
  templates     Template[]
  documents     Document[]
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  @@map("projects")
}

model Template {
  id          String    @id @default(cuid())
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId   String
  name        String
  description String?
  filePath    String    // Storage path (S3 key, FTP path, or local path)
  mimeType    String    // application/pdf, image/png, image/jpeg, application/vnd.openxmlformats-officedocument.wordprocessingml.document
  templateType String   @default("pdf") // "pdf" | "image" | "docx" | "pptx"
  width       Int?      // Width in pixels or points
  height      Int?      // Height in pixels or points
  fields      Json      @default("[]") // Array of zone definitions: {key, x, y, w, h, fontSize, align, type, format} (for PDF/image)
  variables   Json?     // Array of detected variables: [{name: "nom", occurrences: 5}] (for DOCX/PPTX)
  qrcodeConfigs Json?   // Array of QR Code configurations for DOCX: [{placeholder, contentPattern, options, auth, storageUrl}]
  mailDefaults Json?    // Default mailing config: {subject, html, from, fromName, replyTo, attachmentNamePattern}
  documents   Document[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([projectId])
  @@map("templates")
}

model Document {
  id            String    @id @default(cuid())
  project       Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId     String
  template      Template  @relation(fields: [templateId], references: [id], onDelete: Cascade)
  templateId    String
  data          Json      @default("{}") // Data used to render: {recipient_name: "John", ...}
  filePath      String    // Stored file path (S3, FTP, or local)
  mimeType      String    @default("application/pdf")
  status        String    @default("generated") // generated, sent, failed
  recipient     String?   // Email or name of recipient
  recipientEmail String?  // Email address for sending
  emailSentAt   DateTime?
  errorMessage  String?   // Error message if generation or sending failed
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([projectId])
  @@index([templateId])
  @@index([status])
  @@map("documents")
}

