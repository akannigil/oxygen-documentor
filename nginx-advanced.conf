# ============================================================================
# Configuration Nginx avancée pour Oxygen Document
# ============================================================================
# À ajouter dans l'onglet "Advanced" de Nginx Proxy Manager
# 
# IMPORTANT : Remplacez "oxygen-document-app:3000" par votre configuration :
# - Si vous utilisez Docker Compose : oxygen-document-app:PORT
# - Si l'app est sur le même serveur : localhost:PORT
# - PORT par défaut : 3000 (ou celui défini dans APP_PORT dans .env.production)
# ============================================================================

# Augmenter les limites pour les uploads de fichiers volumineux
client_max_body_size 100M;
client_body_buffer_size 128k;

# Timeout pour les requêtes longues (génération de PDF avec Puppeteer)
proxy_connect_timeout 300s;
proxy_send_timeout 300s;
proxy_read_timeout 300s;
proxy_buffering off;

# Headers de sécurité
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;
# Permissions-Policy : À personnaliser selon vos besoins
# add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

# HSTS (HTTP Strict Transport Security)
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

# Désactiver la signature de version Nginx
server_tokens off;

# Configuration du cache pour les assets statiques Next.js
location ~* ^/_next/static/ {
    proxy_pass http://oxygen-document-app:3000;
    proxy_cache_valid 200 365d;
    proxy_cache_key "$scheme$request_method$host$request_uri";
    add_header Cache-Control "public, max-age=31536000, immutable";
    add_header X-Cache-Status $upstream_cache_status;
}

# Configuration du cache pour les images Next.js
location ~* ^/_next/image {
    proxy_pass http://oxygen-document-app:3000;
    proxy_cache_valid 200 7d;
    proxy_cache_key "$scheme$request_method$host$request_uri$arg_url$arg_w$arg_q";
    add_header Cache-Control "public, max-age=604800, immutable";
    add_header X-Cache-Status $upstream_cache_status;
}

# Configuration pour les fichiers statiques (fonts, images, etc.)
location ~* \.(jpg|jpeg|png|gif|ico|svg|webp|woff|woff2|ttf|eot|otf|css|js)$ {
    proxy_pass http://oxygen-document-app:3000;
    expires 1y;
    add_header Cache-Control "public, immutable";
    add_header X-Cache-Status $upstream_cache_status;
    access_log off;
}

# Désactiver le cache pour les API endpoints
location /api/ {
    proxy_pass http://oxygen-document-app:3000;
    proxy_no_cache 1;
    proxy_cache_bypass 1;
    add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
    expires off;
}

# Configuration pour les uploads de fichiers
location /api/uploads/ {
    proxy_pass http://oxygen-document-app:3000;
    proxy_no_cache 1;
    proxy_cache_bypass 1;
    client_max_body_size 100M;
    proxy_request_buffering off;
}

# Support WebSocket (pour Hot Module Replacement en dev si nécessaire)
location /_next/webpack-hmr {
    proxy_pass http://oxygen-document-app:3000;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_cache_bypass $http_upgrade;
}

# Bloquer l'accès aux fichiers sensibles
location ~ /\. {
    deny all;
    access_log off;
    log_not_found off;
}

location ~ /(\.git|\.env|\.vscode|node_modules|package\.json|package-lock\.json|tsconfig\.json) {
    deny all;
    return 404;
}

# Logging optimisé
access_log /var/log/nginx/oxygen-document-access.log combined buffer=32k flush=5s;
error_log /var/log/nginx/oxygen-document-error.log warn;

# Gzip compression
gzip on;
gzip_vary on;
gzip_proxied any;
gzip_comp_level 6;
gzip_types text/plain text/css text/xml text/javascript 
           application/json application/javascript application/xml+rss 
           application/rss+xml application/atom+xml 
           image/svg+xml text/x-component;
gzip_disable "msie6";

# Brotli compression (si le module est disponible)
# brotli on;
# brotli_comp_level 6;
# brotli_types text/plain text/css text/xml text/javascript 
#              application/json application/javascript application/xml+rss 
#              application/rss+xml application/atom+xml 
#              image/svg+xml text/x-component;

